---
title: "Example analysis of standard ellipse area and centroid differences"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sea_and_diff_analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(isoniche)
library(ggplot2)
library(dplyr)
```

This vignette illustrates some of the standard uses and the possibility of non-standard uses of the fitted model objects made possible by taking draws from the joint posterior distribution for the model parameters.

## Loading data and fitting the model

```{r}
# load example data
data("eg_data")

# fit the model
mfit <- isoniche(
  mean = list(
    X1 ~ grp + x,
    X2 ~ grp + x
  ),
  var = list(
    ~ grp,
    ~ grp,
    ~ grp
  ),
  data = eg_data,
  cores = 4
)
```

With the model fitted, we can check the model fit using something akin to a residuals plot (the definition of residuals from a Bayesian standpoint makes it a little less clear how to use them to assess model fit). If the model fits well, we should have *spherical* residuals after we normalize them by premultiplying by the inverse of the matrix square root of the estimated covariance matrix. More precisely, let

$$
{\bf r}_i = \boldsymbol \Sigma_i^{-1/2}({\bf y}_i - \hat{\bf y})
$$
be the length two vector of residuals for observation $i$. If the model fits well, the means of these distributions should be normal with mean zero and variance ${\bf I}_2$. `isoniche` has a default plotting function to create residual plots for the fitted model.

```{r}
plot(mfit)
```

In the upper-left, the residuals are plotted in 2 dimensions and should be approximately spherical. If there are clear clusters of points, especially clusters of points that fall outside the red line, which is an approximate 95\% contour line, then there may be additional structure in the data not accounted for in the model. The other two plots are standard qq plots for the residuals in each dimension.

The model fits well (as it should, considering I know how the data were generated!), so we can move on with the analysis, but you can also get the residuals from the fitted model and add them to the original data for additional plotting (e.g., residuals against missing covariates, like using color to different years over which the data were collected). For more details, see `?residuals.isoniche()`.

## Plotting ellipses

We can create standard ellipse plots using `isoniche::construct_ellipses()` combined with the `ggplot` function `geom_path()`. The `construct_ellipses()` function takes in a new data frame that lists out the conditions for which we want to plot standard ellipses. For example, the data used the fit the model has two groups, groups 1 and 2, and one continuous control variable, `x`. We therefore need to provide which group(s) for which we want to draw ellipses and what value `x` should take. Here is a simple example of drawing an approximate 95% ellipse.

```{r}
# make new data for constructing ellipses
newdat <- data.frame(
  grp = unique(eg_data$grp),
  x = rep(0, length(unique(eg_data$grp)))
)

# set sds to 2 to plot 2sds out from mean
ell_df1 <- construct_ellipses(mfit, newdat, sds = 2)

sea_data <- sea(mfit, newdat, 250)


ggplot(sea_data, aes(x=grp, y = sea)) +
  geom_boxplot()
  

# plot
ggplot(data = eg_data, aes(x = X1, y = X2, color = grp)) +
  geom_point() +
  geom_path(
    data = ell_df1,
    aes(group = ellipse_id),
    linewidth = 2
  ) +
  theme_classic() +
  scale_color_manual(values = c("steelblue", "brown"))

```








